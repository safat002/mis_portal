{% extends "base.html" %}
{% load static %}

{% block title %}Dashboard Designer{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'libs/gridstack/gridstack.min.css' %}">
<link rel="stylesheet" href="{% static 'css/dashboard_designer.css' %}">
{% endblock %}

{% block content %}
<input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">

<div id="designer-root" data-dashboard-id="{{ dashboard.id }}"
  data-config-url="{% url 'mis_app:dashboard_config_api' dashboard_id=dashboard.id %}"
  data-context-url="{% url 'mis_app:dashboard_data_context_api' dashboard_id=dashboard.id %}"
  data-widget-url="{% url 'mis_app:dashboard_widget_data_api' dashboard_id=dashboard.id %}"
  data-can-edit="{{ can_edit|yesno:'1,0' }}">
  <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">

  <header class="dd-topbar">
    <div class="left">
      <a class="dd-breadcrumb" href="{% url 'mis_app:dashboard_management' %}" title="All dashboards">
        <i class="bi bi-arrow-left"></i>
      </a>
      <div class="dd-title-wrap">
        <h1 id="dd-title" class="dd-title" contenteditable="{{ can_edit|yesno:'true,false' }}">
          {{ dashboard.title|default:"Untitled Dashboard" }}
        </h1>
        <div class="dd-save-indicator" title="Autosave status">
          <span id="dd-save-icon" class="dot"></span>
          <span id="dd-save-msg">Saved</span>
        </div>
      </div>
    </div>

    <div class="center">
      <nav class="dd-tabs" aria-label="Pages">
        <ul id="dd-page-tabs" class="dd-tablist" role="tablist"></ul>
        <button id="dd-add-page" class="btn btn-light btn-sm">
          <i class="bi bi-plus-lg me-1"></i>Add page
        </button>
      </nav>
    </div>

    <div class="right">
      <div id="dd-chip-row" class="dd-chip-row"></div>

      <div class="dropdown me-2">
        <button class="btn btn-outline-secondary btn-sm dropdown-toggle" data-bs-toggle="dropdown">
          <i class="bi bi-palette me-1"></i>Theme
        </button>
        <ul id="dd-theme-menu" class="dropdown-menu dropdown-menu-end"></ul>
      </div>

      <button id="dd-data-context" class="btn btn-outline-secondary btn-sm me-2" data-bs-toggle="modal"
        data-bs-target="#dataContextModal">
        <i class="bi bi-diagram-3 me-1"></i>Data context
      </button>

      <button id="dd-global-filters" class="btn btn-outline-secondary btn-sm me-2" data-bs-toggle="offcanvas"
        data-bs-target="#drawer-filters">
        <i class="bi bi-funnel me-1"></i>Filters
      </button>

      <div class="btn-group">
        <button id="dd-export-png" class="btn btn-outline-secondary btn-sm"><i class="bi bi-image"></i></button>
        <button id="dd-toggle-grid" class="btn btn-outline-secondary btn-sm"><i class="bi bi-grid-3x3"></i></button>
      </div>
    </div>
  </header>

  <div class="dd-layout">
    <aside class="dd-sidebar">
      <div class="dd-section">
        <div class="dd-section-title">Widgets</div>
        <div class="dd-palette">
          <button class="dd-palette-item" data-widget="kpi"><i class="bi bi-123"></i><span>KPI / Card</span></button>
          <button class="dd-palette-item" data-widget="bar"><i class="bi bi-bar-chart"></i><span>Bar</span></button>
          <button class="dd-palette-item" data-widget="line"><i class="bi bi-graph-up"></i><span>Line</span></button>
          <button class="dd-palette-item" data-widget="pie"><i class="bi bi-pie-chart"></i><span>Pie</span></button>
          <button class="dd-palette-item" data-widget="doughnut"><i
              class="bi bi-circle-half"></i><span>Doughnut</span></button>
          <button class="dd-palette-item" data-widget="table"><i class="bi bi-table"></i><span>Data
              Table</span></button>
          <button class="dd-palette-item" data-widget="slicer"><i class="bi bi-funnel"></i><span>Slicer</span></button>
          <button class="dd-palette-item" data-widget="button_slicer"><i class="bi bi-ui-checks-grid"></i><span>Button
              Slicer</span></button>
        </div>
      </div>

      <div class="dd-section">
        <div class="dd-section-title">Learn</div>
        <button class="link-quiet">How to build joins</button><br>
        <button class="link-quiet">Chart best practices</button>
      </div>
    </aside>

    <main class="dd-canvas">
      <div class="dd-page-toolbar">
        <div class="btn-group">
          <button id="dd-duplicate" class="btn btn-light btn-sm" disabled title="Duplicate selected"><i
              class="bi bi-files"></i></button>
          <button id="dd-delete" class="btn btn-light btn-sm" disabled title="Delete selected"><i
              class="bi bi-trash"></i></button>
        </div>
        <div class="btn-group">
          <button id="dd-align-left" class="btn btn-light btn-sm" disabled title="Align left"><i
              class="bi bi-distribute-horizontal"></i></button>
          <button id="dd-align-top" class="btn btn-light btn-sm" disabled title="Align top"><i
              class="bi bi-distribute-vertical"></i></button>
          <button id="dd-distribute" class="btn btn-light btn-sm" disabled title="Distribute"><i
              class="bi bi-layout-three-columns"></i></button>
        </div>
        <div class="dd-quick-actions">
          <span class="label text-muted">Quick add:</span>
          <button class="btn btn-outline-secondary btn-sm dd-quick-add" data-widget="kpi">KPI</button>
          <button class="btn btn-outline-secondary btn-sm dd-quick-add" data-widget="bar">Bar</button>
          <button class="btn btn-outline-secondary btn-sm dd-quick-add" data-widget="line">Line</button>
          <button class="btn btn-outline-secondary btn-sm dd-quick-add" data-widget="table">Table</button>
        </div>
      </div>

      <div class="dd-page-container" id="dd-page-container"></div>
      <div class="dd-empty-hint" id="dd-empty-hint">
        <div class="inner">
          <i class="bi bi-plus-circle"></i>
          <p class="mb-0">Drag a widget from the left to get started.</p>
        </div>
      </div>
    </main>

    <aside class="dd-inspector">
      <div class="dd-inspector-tabs">
        <button class="active" data-tab="data">Data</button>
        <button data-tab="style">Style</button>
        <button data-tab="interactions">Interactions</button>
      </div>
      <div class="dd-inspector-body">
        <section class="dd-pane" data-pane="data">
          <div id="dd-data-fields-group" class="dd-group dd-data-fields">
            <div class="dd-group-title">Fields</div>
            <div class="small text-muted">Select a connection and tables in <strong>Data context</strong> to see fields.
            </div>
          </div>
          <div id="dd-data-config-group" class="dd-group dd-data-config">
            <div class="dd-group-title">Widget Data</div>
            <div class="small text-muted">Select a widget on the canvas to configure its fields.</div>
          </div>
        </section>
        <section class="dd-pane d-none" data-pane="style">
          <div class="dd-group">
            <div class="dd-group-title">Appearance</div>
            <div class="small text-muted">Colors, fonts, legend, axes.</div>
          </div>
        </section>
        <section class="dd-pane d-none" data-pane="interactions">
          <div class="dd-group">
            <div class="dd-group-title">Behaviors</div>
            <div class="small text-muted">Cross-filtering, drill, hover actions.</div>
          </div>
        </section>
      </div>
    </aside>
  </div>

  <div class="offcanvas offcanvas-end" tabindex="-1" id="drawer-filters" aria-labelledby="drawer-filters-label">
    <div class="offcanvas-header">
      <h5 id="drawer-filters-label"><i class="bi bi-funnel me-2"></i>Global filters</h5>
      <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
    </div>
    <div class="offcanvas-body">
      <div id="gf-builder"></div>
    </div>
    <div class="offcanvas-footer p-3 border-top">
      <button class="btn btn-secondary" data-bs-dismiss="offcanvas">Close</button>
      <button id="gf-apply" class="btn btn-primary">Apply</button>
    </div>
  </div>
</div>

{% include "partials/data_context_modal.html" %}
{% include "partials/widget_settings_modal.html" %}
{% include "partials/global_filter_modal.html" %}
{% include "partials/export_modal.html" %}
{% endblock %}


{% block extra_js %}
<script src="{% static 'libs/html2canvas/html2canvas.min.js' %}"></script>
<script src="{% static 'libs/gridstack/gridstack-all.js' %}"></script>
<script src="{% static 'libs/chartjs/chart.umd.min.js' %}"></script>
<script src="{% static 'js/event_bus.js' %}"></script>
<script src="{% static 'js/toast-notifications.js' %}"></script>
<script src="{% static 'js/color_service.js' %}"></script>
<script src="{% static 'js/widget_renderer.js' %}"></script>
<script src="{% static 'js/export_service.js' %}"></script>
<script src="{% static 'js/dashboard_designer.js' %}"></script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const root = document.getElementById('designer-root');
    const canEdit = root?.dataset.canEdit === '1';

    if (!canEdit) {
      const title = document.getElementById('dd-title');
      if (title) title.setAttribute('contenteditable', 'false');
      ['#dd-add-page', '#ctx-apply', '#gf-apply', '.dd-palette-item', '.dd-quick-add']
        .forEach(sel => document.querySelectorAll(sel).forEach(btn => btn.setAttribute('disabled', 'disabled')));
    }

    console.log('Designer boot check:', {
      canEdit,
      gridstackLoaded: typeof GridStack !== 'undefined',
      chartJsLoaded: typeof Chart !== 'undefined'
    });
  });
</script>
{% endblock %}